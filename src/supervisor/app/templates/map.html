<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Коммунальные проблемы Саратовской области</title>
	<link rel="stylesheet" href="/static/style.css">
</head>
<body>
	<main>
		<div id="map" class="map"></div>
		<div class="legend">
			<h2> Жилищно-коммунальные проблемы Саратовской обл. </h2>
			<button class="card_1" onclick="filterMarkers('Водоснабжение')">
				<img src="/static/water_supply.png">
				<p> Водоснабжение </p>
			</button>
			<button class="card_2" onclick="filterMarkers('Теплоснабжение')">
				<img src="/static/heat_supply.png">
				<p> Теплоснабжение и <br> горячее водоснабжение </p>
			</button>
			<button class="card_3" onclick="filterMarkers('Электроснабжение')">
				<img src="/static/electricity_supply.png">
				<p> Электроснабжение </p>
			</button>
			<button class="card_4" onclick="filterMarkers('Дорожное хозяйство')">
				<img src="/static/road_infrastructure.png">
				<p> Дорожное хозяйство </p>
			</button>
			<button class="card_all" onclick="showMarkers()">
				<p> Показать все </p>
			</button>
		</div>
	</main>
	<script src="https://api-maps.yandex.ru/2.1/?apikey=04115428-c44a-47da-8e64-57b42eaddda3&lang=ru_RU"></script>
<!--	<script src="/static/map.js"></script>-->
	<script>
ymaps.ready(init);

var map;
const DATA = {{ messages|tojson|safe }};

let area = [[51.36797765022104,45.439861987792945], [51.71308855448513,46.57488701220701]];
let center = [51.533562, 46.034266];
let zoom = 13;

// Функция инициализации карты
function init() {
	// Создание экземпляра карты и его привязка к контейнеру с заданным id
	map = new ymaps.Map('map', {
		center: center,
		zoom: zoom
	}, {
		// Зададим ограниченную область прямоугольником, примерно описывающим город
		restrictMapArea: area
	}),
	clusterer = new ymaps.Clusterer({
		// Макет метки кластера pieChart
		clusterIconLayout: 'default#pieChart',
		// Радиус диаграммы в пикселях
		clusterIconPieChartRadius: 20,
		// Радиус центральной части макета
		clusterIconPieChartCoreRadius: 10,
		// Ширина линий-разделителей секторов и внешней обводки диаграммы
		clusterIconPieChartStrokeWidth: 2,
		// Определяет наличие поля balloon
		hasBalloon: true
	});

	if (DATA) {
		showMarkers();
	}
	map.geoObjects.add(clusterer);         // вывод кластеров с геообъектами
	map.controls.remove('trafficControl'); // удаляем контроль трафика
}

// Функция отображения меток на карте
function showMarkers(data = DATA) {
    // Очищаем кластеризатор от предыдущих меток
    clusterer.removeAll();

    // Проходим по всем данным и добавляем метки в кластеризатор
	data.forEach(message => {
		// Используем данные каждого сообщения для отображения проблемы на карте

		// Определение цвета метки по соответствующему тегу проблемы
		let color = getColorByProblem(message.problem);

		// Преобразование координат в формат [широта, долгота]
		const [latitude, longitude] = message.coordinates.split(' ').map(parseFloat);

		// Создание и добавление метки в кластер
		clusterer.add(new ymaps.Placemark([longitude, latitude], {
			balloonContentHeader: message.problem,
			balloonContentBody: message.address,
			balloonContentFooter: message.date
		}, {
			preset: 'islands#dotIcon',
			iconColor: color
		}));
	});
}

// Функция для определения цвета иконки метки по типу проблемы
function getColorByProblem(problem) {
	switch (problem) {
		case 'Водоснабжение':
			return '#4FAEEE';
		case 'Теплоснабжение':
			return '#EE4B68';
		case 'Электроснабжение':
			return '#EEA849';
		case 'Дорожное хозяйство':
			return '#4CEB66';
		default:
			return '#808080';
	}
}

function filterMarkers(problem) {
	// Отображаем только метки с выбранным типом проблемы
    let filteredData = DATA.filter(item => item.problem === problem);

    // Отображаем отфильтрованные метки на карте
    showMarkers(filteredData);
}
	</script>
</body>
</html>